#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Auto-generate credentials if not provided
# Store master key in persistent storage so it survives container restarts
STORED_KEY_PATH="/rails/storage/master.key"

if [ -z "${RAILS_MASTER_KEY}" ]; then
  # Ensure storage directory exists
  mkdir -p /rails/storage

  if [ -f "$STORED_KEY_PATH" ]; then
    echo "Loading existing master key from storage..."
    export RAILS_MASTER_KEY=$(cat "$STORED_KEY_PATH")
  elif [ "${1}" == "bin/jobs" ]; then
    # Jobs container: wait for web to generate the key
    echo "Waiting for master key to be generated by web container..."
    for i in {1..30}; do
      if [ -f "$STORED_KEY_PATH" ]; then
        export RAILS_MASTER_KEY=$(cat "$STORED_KEY_PATH")
        echo "Master key loaded."
        break
      fi
      sleep 1
    done
    if [ -z "${RAILS_MASTER_KEY}" ]; then
      echo "ERROR: Master key not found after 30 seconds. Is the web container running?"
      exit 1
    fi
  else
    # Web container: generate new key
    echo "Generating new master key..."
    export RAILS_MASTER_KEY=$(openssl rand -hex 16)
    echo -n "$RAILS_MASTER_KEY" > "$STORED_KEY_PATH"
    chmod 600 "$STORED_KEY_PATH"

    echo "=============================================="
    echo "New master key generated and saved to storage."
    echo "Your data is encrypted with this key."
    echo "Back up the storage volume to preserve your data."
    echo "=============================================="
  fi
fi

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
