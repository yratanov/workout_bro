<% content_for :title, t(".title") %>

<div class="w-full max-w-xl mx-auto py-8">
  <% if @workout.strength? %>
    <!-- Strength Workout Summary -->
    <div class="text-center mb-8">
      <div
        class="
          inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full
          bg-green-500/20
        "
      >
        <%= icon "check", size: "w-8 h-8", class: "text-green-400" %>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2"><%= t(".title") %></h1>
      <p class="text-slate-400">
        <% if @workout.workout_routine_day %>
          <%= @workout.workout_routine.name %>
          Â·
          <%= @workout.workout_routine_day.name %>
        <% else %>
          <%= t(".custom_workout") %>
        <% end %>
      </p>
    </div>
    <!-- Stats Grid -->
    <div class="grid grid-cols-3 gap-4 mb-8">
      <%= stat_card label: t(".total_volume") do %>
        <%= format_volume(@summary.total_volume) %>
      <% end %>
      <%= stat_card label: t(".sets") do %>
        <%= @summary.total_sets %>
      <% end %>
      <%= stat_card label: t(".duration") do %>
        <%= seconds_to_human(@summary.duration || 0) %>
      <% end %>
    </div>
    <!-- Muscles Worked -->
    <% if @summary.muscles_worked.any? %>
      <div class="bg-slate-800 rounded-lg p-4 mb-6">
        <h3 class="text-slate-400 text-sm mb-3"><%= t(".muscles_worked") %></h3>
        <div class="flex flex-wrap gap-3">
          <% @summary.muscles_worked.each do |muscle| %>
            <div class="flex items-center gap-2 bg-slate-700 rounded-full px-3 py-1.5">
              <%= muscle_icon(muscle, size: "w-5 h-5") %>
              <span class="text-white text-sm"><%= muscle.human_name %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    <!-- PRs Section -->
    <% if @summary.new_prs.any? %>
      <div class=" bg-slate-800 rounded-lg p-4 mb-6 border-2 border-yellow-500/50 ">
        <div class="flex items-center gap-2 mb-3">
          <%= icon "trophy", size: "w-5 h-5", class: "text-yellow-400" %>
          <h3 class="text-yellow-400 font-semibold"><%= t(".new_prs") %></h3>
        </div>
        <div class="space-y-2">
          <% @summary.new_prs.each do |pr| %>
            <div
              class="
                flex items-center justify-between bg-slate-700 rounded-lg px-3 py-2
              "
            >
              <span class="text-white"><%= pr.exercise.name %></span>
              <div class="flex items-center gap-2">
                <span class="text-slate-400 text-sm"><%= pr_type_label(pr.pr_type) %></span>
                <span class="text-yellow-400 font-semibold">
                  <% if pr.max_weight? %>
                    <%= pr.weight %>kg
                  <% elsif pr.max_volume? %>
                    <%= pr.volume.to_i %>kg
                  <% else %>
                    <%= pr.reps %>
                    reps
                  <% end %>
                </span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    <!-- Comparison Section -->
    <% if @summary.previous_workout && @summary.comparison %>
      <div class="bg-slate-800 rounded-lg p-4 mb-6">
        <h3 class="text-slate-400 text-sm mb-3"><%= t(".comparison_title") %></h3>
        <div class="flex items-center justify-between">
          <span class="text-white"><%= t(".volume") %></span>
          <div class="flex items-center gap-2">
            <span class="<%= comparison_class(@summary.comparison.volume_diff) %>">
              <%= icon comparison_arrow(@summary.comparison.volume_diff), size: "w-4 h-4" %>
            </span>
            <span
              class="<%= comparison_class(@summary.comparison.volume_diff) %> font-semibold"
            >
              <% if @summary.comparison.volume_diff >= 0 %>+<% end %><%= format_volume(@summary.comparison.volume_diff) %>
            </span>
            <span class="text-slate-500 text-sm">
              (<% if @summary.comparison.volume_diff_percent >= 0 %>+<% end %><%= @summary.comparison.volume_diff_percent %>%)
            </span>
          </div>
        </div>
      </div>
    <% elsif @summary.previous_workout.nil? %>
      <div class=" bg-slate-800 rounded-lg p-4 mb-6 text-center text-slate-400 ">
        <%= t(".first_time") %>
      </div>
    <% end %>
    <!-- Workout Notes Section -->
    <%= render partial: "workouts/notes",
    locals: {
      workout: @workout,
      edit_path: notes_modal_workout_path(@workout),
    } %>
    <!-- Set Notes Section -->
    <%= render partial: "workouts/set_notes", locals: { workout: @workout } %>

  <% else %>
    <!-- Run Workout Summary -->
    <div class="text-center mb-8">
      <div
        class="
          inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full
          bg-green-500/20
        "
      >
        <%= icon "check", size: "w-8 h-8", class: "text-green-400" %>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2"><%= t(".run_complete") %></h1>
      <p class="text-slate-400"><%= @workout.started_at.strftime("%d %b %Y") %></p>
    </div>
    <!-- Run Stats Grid -->
    <div class="grid grid-cols-3 gap-4 mb-8">
      <%= stat_card label: t(".distance") do %>
        <%= (@summary.distance.to_f / 1000).round(2) %>
        km
      <% end %>
      <%= stat_card label: t(".duration") do %>
        <%= seconds_to_human(@summary.duration || 0) %>
      <% end %>
      <%= stat_card label: t(".pace") do %>
        <%= format_pace(@summary.pace) %>
        <div class="text-slate-500 text-xs font-normal"><%= t(".pace_unit") %></div>
      <% end %>
      <% if @workout.avg_heart_rate.present? %>
        <%= stat_card label: t(".avg_hr") do %>
          <%= @workout.avg_heart_rate %>
          <span class="text-sm text-slate-400">bpm</span>
        <% end %>
      <% end %>
      <% if @workout.max_heart_rate.present? %>
        <%= stat_card label: t(".max_hr") do %>
          <%= @workout.max_heart_rate %>
          <span class="text-sm text-slate-400">bpm</span>
        <% end %>
      <% end %>
      <% if @workout.avg_cadence.present? %>
        <%= stat_card label: t(".cadence") do %>
          <%= @workout.avg_cadence %>
          <span class="text-sm text-slate-400">spm</span>
        <% end %>
      <% end %>
      <% if @workout.elevation_gain.present? %>
        <%= stat_card label: t(".elevation") do %>
          <%= @workout.elevation_gain.round(0) %>
          <span class="text-sm text-slate-400">m</span>
        <% end %>
      <% end %>
      <% if @workout.vo2max.present? %>
        <%= stat_card label: t(".vo2max") do %>
          <%= @workout.vo2max.round(1) %>
        <% end %>
      <% end %>
    </div>
    <!-- Run PRs Section -->
    <% if @summary.new_prs.any? %>
      <div class=" bg-slate-800 rounded-lg p-4 mb-6 border-2 border-yellow-500/50 ">
        <div class="flex items-center gap-2 mb-3">
          <%= icon "trophy", size: "w-5 h-5", class: "text-yellow-400" %>
          <h3 class="text-yellow-400 font-semibold"><%= t(".new_prs") %></h3>
        </div>
        <div class="space-y-2">
          <% @summary.new_prs.each do |pr| %>
            <div
              class="
                flex items-center justify-between bg-slate-700 rounded-lg px-3 py-2
              "
            >
              <span class="text-slate-400 text-sm"><%= pr_type_label(pr.pr_type) %></span>
              <span class="text-yellow-400 font-semibold">
                <% if pr.longest_distance? %>
                  <%= (pr.distance.to_f / 1000).round(2) %>
                  km
                <% elsif pr.fastest_pace? %>
                  <%= format_pace(pr.pace) %>
                  min/km
                <% end %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    <!-- Run Comparison -->
    <% if @summary.previous_workout && @summary.comparison&.pace_diff %>
      <div class="bg-slate-800 rounded-lg p-4 mb-6">
        <h3 class="text-slate-400 text-sm mb-3"><%= t(".comparison_title") %></h3>
        <div class="flex items-center justify-between">
          <span class="text-white"><%= t(".pace") %></span>
          <div class="flex items-center gap-2">
            <% pace_improved = @summary.comparison.pace_diff > 0 %>
            <span
              class="<%= pace_improved ? 'text-green-400' : 'text-red-400' %> font-semibold"
            >
              <%= format_pace_diff(@summary.comparison.pace_diff) %>
              <%= pace_improved ? t(".faster") : t(".slower") %>
            </span>
          </div>
        </div>
      </div>
    <% elsif @summary.previous_workout.nil? %>
      <div class=" bg-slate-800 rounded-lg p-4 mb-6 text-center text-slate-400 ">
        <%= t(".first_time") %>
      </div>
    <% end %>
    <!-- Notes Section -->
    <%= render partial: "workouts/notes",
    locals: {
      workout: @workout,
      edit_path: notes_modal_workout_path(@workout),
    } %>
  <% end %>
  <!-- AI Trainer Feedback -->
  <% if current_user.ai_trainer&.configured? %>
    <div
      class="bg-slate-800 rounded-lg p-4 mb-6"
      data-controller="ai-feedback"
      data-ai-feedback-url-value="<%= ai_feedback_status_workout_path(@workout) %>"
    >
      <div class="flex items-center gap-2 mb-3">
        <%= icon "sparkles", size: "w-5 h-5", class: "text-purple-400" %>
        <h3 class="text-purple-400 font-semibold">
          <%= t(".ai_feedback_title") %>
        </h3>
      </div>
      <% if @workout.ai_summary.present? %>
        <div class="text-slate-300 text-sm prose prose-invert prose-sm max-w-none">
          <%= render_markdown(@workout.ai_summary) %>
        </div>
      <% else %>
        <div data-ai-feedback-target="loading">
          <div class="flex items-center gap-2 text-slate-400 text-sm">
            <div
              class="
                w-4 h-4 border-2 border-purple-400 border-t-transparent rounded-full
                animate-spin
              "
            ></div>
            <span><%= t(".ai_feedback_loading") %></span>
          </div>
        </div>
        <div
          data-ai-feedback-target="content"
          class="text-slate-300 text-sm prose prose-invert prose-sm max-w-none"
        ></div>
      <% end %>
    </div>
  <% end %>
  <!-- Action Buttons -->
  <div class="flex gap-3 justify-center mt-8">
    <%= button t(".view_details"),
    type: "link",
    style: "outlined",
    route: workout_path(@workout) %>
    <%= button t(".back_to_calendar"),
    type: "link",
    style: "primary",
    route: workouts_path %>
  </div>
</div>
