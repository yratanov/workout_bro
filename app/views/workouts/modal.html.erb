<%= turbo_frame_tag "workout_modal" do %>
  <div
    data-controller="modal"
    data-modal-auto-open-value="true"
    data-modal-turbo-frame-value="workout_modal"
  >
    <%= modal title: modal_title(@workout), size: "md" do %>
      <div class="p-6 overflow-y-auto min-h-0 flex-1">
        <% if @workout.strength? %>
          <!-- Stats Grid -->
          <div class="grid grid-cols-3 gap-3 mb-4">
            <%= stat_card label: t(".total_volume"), size: :sm do %>
              <%= format_volume(@summary.total_volume) %>
            <% end %>
            <%= stat_card label: t(".sets"), size: :sm do %>
              <%= @summary.total_sets %>
            <% end %>
            <%= stat_card label: t(".duration"), size: :sm do %>
              <%= seconds_to_human(@summary.duration || 0) %>
            <% end %>
          </div>
          <!-- Muscles Worked -->
          <% if @summary.muscles_worked.any? %>
            <div class="mb-4">
              <div class="text-slate-400 text-xs mb-2"><%= t(".muscles_worked") %></div>
              <div class="flex flex-wrap gap-2">
                <% @summary.muscles_worked.each do |muscle| %>
                  <div class=" flex items-center gap-1.5 bg-slate-700 rounded-full px-2.5 py-1 ">
                    <%= muscle_icon(muscle, size: "w-4 h-4") %>
                    <span class="text-white text-sm"><%= muscle.human_name %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <!-- Comparison (if available) -->
          <% if @summary.previous_workout && @summary.comparison %>
            <div class="bg-slate-700 rounded-lg p-3 mb-4">
              <div class="flex items-center justify-between">
                <span class="text-slate-400 text-sm"><%= t(".vs_last") %></span>
                <div class="flex items-center gap-2">
                  <span class="<%= comparison_class(@summary.comparison.volume_diff) %>">
                    <%= icon comparison_arrow(@summary.comparison.volume_diff), size: "w-4 h-4" %>
                  </span>
                  <span
                    class="
                      <%= comparison_class(@summary.comparison.volume_diff) %> font-semibold
                    "
                  >
                    <% if @summary.comparison.volume_diff >= 0 %>+<% end %><%= format_volume(@summary.comparison.volume_diff) %>
                  </span>
                  <span class="text-slate-500 text-sm">
                    (<% if @summary.comparison.volume_diff_percent >= 0 %>+<% end %><%= @summary.comparison.volume_diff_percent %>%)
                  </span>
                </div>
              </div>
            </div>
          <% end %>

          <% if @workout.workout_sets.empty? %>
            <p class="text-slate-400 text-center"><%= t(".no_exercises") %></p>
          <% end %>
          <!-- Workout Notes -->
          <% if @workout.notes.present? %>
            <div class="mb-4">
              <div class="text-slate-400 text-xs mb-2"><%= t(".notes") %></div>
              <div class="bg-slate-700/50 rounded-lg p-3">
                <p class="text-slate-300 text-sm whitespace-pre-wrap"><%= @workout.notes %></p>
              </div>
            </div>
          <% end %>
          <!-- Set Notes -->
          <%= render partial: "workouts/set_notes",
          locals: {
            workout: @workout,
            compact: true,
          } %>
        <% else %>
          <!-- Run Workout Stats -->
          <div class="grid grid-cols-3 gap-3 mb-4">
            <%= stat_card label: t(".distance"), size: :sm do %>
              <%= (@summary.distance.to_f / 1000).round(2) %>
              km
            <% end %>
            <%= stat_card label: t(".duration"), size: :sm do %>
              <%= seconds_to_human(@summary.duration || 0) %>
            <% end %>
            <%= stat_card label: t(".pace"), size: :sm do %>
              <%= format_pace(@summary.pace) %>
            <% end %>
            <% if @workout.avg_heart_rate.present? %>
              <%= stat_card label: t(".avg_hr"), size: :sm do %>
                <%= @workout.avg_heart_rate %>
                bpm
              <% end %>
            <% end %>
            <% if @workout.max_heart_rate.present? %>
              <%= stat_card label: t(".max_hr"), size: :sm do %>
                <%= @workout.max_heart_rate %>
                bpm
              <% end %>
            <% end %>
            <% if @workout.avg_cadence.present? %>
              <%= stat_card label: t(".cadence"), size: :sm do %>
                <%= @workout.avg_cadence %>
                spm
              <% end %>
            <% end %>
            <% if @workout.elevation_gain.present? %>
              <%= stat_card label: t(".elevation"), size: :sm do %>
                <%= @workout.elevation_gain.round(0) %>
                m
              <% end %>
            <% end %>
            <% if @workout.vo2max.present? %>
              <%= stat_card label: t(".vo2max"), size: :sm do %>
                <%= @workout.vo2max.round(1) %>
              <% end %>
            <% end %>
          </div>
          <!-- Run Comparison -->
          <% if @summary.previous_workout && @summary.comparison&.pace_diff %>
            <div class="bg-slate-700 rounded-lg p-3 mb-4">
              <div class="flex items-center justify-between">
                <span class="text-slate-400 text-sm"><%= t(".vs_last") %></span>
                <div class="flex items-center gap-2">
                  <% pace_improved = @summary.comparison.pace_diff > 0 %>
                  <span
                    class="
                      <%= pace_improved ? 'text-green-400' : 'text-red-400' %> font-semibold
                    "
                  >
                    <%= format_pace_diff(@summary.comparison.pace_diff) %>
                    <%= pace_improved ? t(".faster") : t(".slower") %>
                  </span>
                </div>
              </div>
            </div>
          <% end %>
          <!-- Workout Notes (Run) -->
          <% if @workout.notes.present? %>
            <div class="mb-4">
              <div class="text-slate-400 text-xs mb-2"><%= t(".notes") %></div>
              <div class="bg-slate-700/50 rounded-lg p-3">
                <p class="text-slate-300 text-sm whitespace-pre-wrap"><%= @workout.notes %></p>
              </div>
            </div>
          <% end %>
        <% end %>
        <!-- AI Trainer Feedback -->
        <% if @workout.ai_summary.present? %>
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
              <%= icon "sparkles", size: "w-4 h-4", class: "text-purple-400" %>
              <div class="text-purple-400 text-xs font-semibold"><%= t(".ai_feedback_title") %></div>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3">
              <div class="text-slate-300 text-sm prose prose-invert prose-sm max-w-none">
                <%= render_markdown(@workout.ai_summary) %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <div class="p-6 border-t border-slate-700 flex justify-between flex-shrink-0">
        <div class="flex gap-2">
          <%= button t(".close"), style: "outlined", data: { action: "click->modal#close" } %>
          <%= button t(".view_details"),
          type: "link",
          style: "primary",
          route: workout_path(@workout),
          data: {
            turbo_frame: "_top",
          } %>
        </div>
        <%= button t(".delete"),
        style: "danger",
        method: :delete,
        route: workout_path(@workout),
        data: {
          turbo_confirm: t(".delete_confirm"),
          turbo_frame: "_top",
        } %>
      </div>
    <% end %>
  </div>
<% end %>
