<!DOCTYPE html>
<html class="w-full">
  <head>
    <title><%= content_for(:title) || t("shared.app_name") %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <%= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon2.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon2.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="w-full relative">
    <% if flash.any? %>
      <div
        class="
          fixed top-4 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 z-50
          flex flex-col items-center gap-2
        "
      >
        <% flash.each do |type, message| %>
          <div
            data-controller="flash"
            class="
              w-full sm:w-auto max-w-md px-4 py-3 rounded-lg font-medium shadow-xl border
              backdrop-blur-sm transition-all duration-300 ease-in-out text-sm sm:text-base
              <%= type == 'alert' ? 'bg-red-800 text-red-100 border-red-600' : 'bg-green-800 text-green-100 border-green-600' %>
            "
          >
            <%= message %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if authenticated? && Current.user&.setup_completed? %>
      <% nav_items = [
        {
          name: t("shared.navigation.workouts"),
          path: workouts_path,
          current: controller_name == "workouts",
        },
        {
          name: t("shared.navigation.routines"),
          path: workout_routines_path,
          current: controller_name == "workout_routines",
        },
        {
          name: t("shared.navigation.prs"),
          path: personal_records_path,
          current: controller_name == "personal_records",
        },
        {
          name: t("shared.navigation.stats"),
          path: stats_path,
          current: controller_name == "stats",
        },
        {
          name: t("shared.navigation.ai"),
          path: ai_trainer_activities_path,
          current: controller_name == "ai_trainer_activities",
          badge: Current.user.ai_trainer_activities.unviewed.exists?,
        },
        {
          name: t("shared.navigation.exercises"),
          path: exercises_path,
          current: controller_name == "exercises",
        },
        {
          name: t("shared.navigation.supersets"),
          path: supersets_path,
          current: controller_name == "supersets",
        },
      ] %>
      <nav
        class="w-full bg-slate-800 border-b border-slate-700"
        data-controller="mobile-menu"
      >
        <div class="max-w-5xl mx-auto px-4 flex items-center justify-between">
          <div class="flex items-center">
            <%= link_to workouts_path, class: "flex items-center gap-2 py-3 pr-4 hover:opacity-80 transition-opacity" do %>
              <%= image_tag "icon.png", class: "w-8 h-8" %>
              <span class="font-semibold text-lg hidden sm:block"><%= t("shared.app_name") %></span>
            <% end %>
            <div class="hidden sm:flex items-center gap-1">
              <% nav_items.each do |item| %>
                <%= link_to item[:path],
                class:
                  "relative px-3 py-2 rounded-md text-sm font-medium transition-colors #{item[:current] ? "bg-slate-700 text-white" : "text-slate-300 hover:bg-slate-700 hover:text-white"}" do %>
                  <%= item[:name] %>
                  <% if item[:badge] %>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
          <div class="flex items-center gap-1">
            <button
              type="button"
              data-action="mobile-menu#toggle"
              class="
                sm:hidden p-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700
                transition-colors
              "
            >
              <span data-mobile-menu-target="openIcon"><%= icon "menu", size: "w-5 h-5" %></span>
              <span data-mobile-menu-target="closeIcon" class="hidden"><%= icon "xmark", size: "w-5 h-5" %></span>
            </button>
            <% if Current.user&.admin? %>
              <%= link_to admin_logs_path,
                class: "p-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors",
                title: t("shared.navigation.admin") do %>
                <%= icon "shield" %>
              <% end %>
            <% end %>
            <%= link_to settings_profile_path,
              class: "p-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors" do %>
              <%= icon "settings" %>
            <% end %>
            <%= link_to session_path,
              method: :destroy,
              data: { turbo_method: :delete },
              class: "p-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors" do %>
              <%= icon "exit" %>
            <% end %>
          </div>
        </div>
        <!-- Mobile menu -->
        <div
          data-mobile-menu-target="menu"
          class="hidden sm:hidden border-t border-slate-700"
        >
          <div class="px-2 py-3 space-y-1">
            <% nav_items.each do |item| %>
              <%= link_to item[:path],
              data: {
                action: "mobile-menu#close",
              },
              class:
                "relative flex items-center gap-2 px-3 py-2 rounded-md text-base font-medium transition-colors #{item[:current] ? "bg-slate-700 text-white" : "text-slate-300 hover:bg-slate-700 hover:text-white"}" do %>
                <%= item[:name] %>
                <% if item[:badge] %>
                  <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      </nav>
    <% end %>
    <main class="w-full mt-10 px-5 flex justify-center">
      <div class="flex w-full justify-center">
        <%= yield %>
      </div>
    </main>
    <%= turbo_frame_tag "notes_modal" %>
    <!-- iOS Install Prompt -->
    <div data-controller="ios-install-prompt">
      <div
        data-ios-install-prompt-target="banner"
        class="
          hidden fixed bottom-0 left-0 right-0 z-50 bg-slate-800 border-t border-slate-600
          p-4 shadow-lg transition-all duration-300 ease-in-out
        "
      >
        <div class="max-w-lg mx-auto flex items-start gap-3">
          <%= image_tag "icon.png", class: "w-12 h-12 rounded-xl flex-shrink-0" %>
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-white text-sm">
              <%= t("shared.ios_install_prompt.title") %>
            </p>
            <p class="text-slate-300 text-xs mt-1">
              <%= t("shared.ios_install_prompt.instructions_html") %>
            </p>
          </div>
          <button
            type="button"
            data-action="ios-install-prompt#dismiss"
            class="text-slate-400 hover:text-white p-1 flex-shrink-0"
            aria-label="<%= t("shared.buttons.cancel") %>"
          >
            <%= icon "xmark", size: "w-5 h-5" %>
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
